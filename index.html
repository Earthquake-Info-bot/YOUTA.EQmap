<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Y地震マップv1.10.7</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html {
  font-size: 300%;
  }
  #map { width: 100%; height: 100vh; }
  .intensity-marker {
    display:flex;
    justify-content:center;
    align-items:center;
    border-radius:50%;
    width:96px;
    height:96px;
    font-weight:bold;
    font-size:42px;
    border:6px solid rgba(0,0,0,0.2);
    box-sizing:border-box;
    pointer-events:none;
  }
  #loading {
    position:absolute;
    top:30px;
    left:50%;
    transform:translateX(-50%);
    background:white;
    padding:5px 10px;
    border:1px solid black;
    z-index:100000;
    font-weight:bold;
    font-family:"Yu Gothic","YuGothic","メイリオ",sans-serif;
  }
  #hypo-info {
    position:absolute;
    top:10px;
    left:10px;
    background:rgba(255,255,255,0.9);
    padding:8px 12px;
    border:1px solid black;
    font-family:"Yu Gothic","YuGothic","メイリオ",sans-serif;
    z-index:100000;
    font-weight:bold;
    cursor:move;
    line-height:1.1;
  }
  #max-intensity {
    min-width:80px;
    border:1px solid black;
    text-align:center;
    font-family:"Yu Gothic","YuGothic","メイリオ",sans-serif;
    position:absolute;
    left:10px;
    z-index:100000;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    padding:3px 10px;
    box-sizing:border-box;
    border-radius:0;
  }
  #max-intensity .label {
    font-size:0.85em;
    font-weight:normal;
    margin-bottom:1px;
    width:100%;
    box-sizing:border-box;
  }
  #max-intensity .scale {
    font-size:2.2em;
    font-weight:bold;
    line-height:1;
    margin:0;
    padding:0;
    height:auto;
    width:auto;
    box-sizing:border-box;
  }
  #help-checkbox-container {
    margin-top: 10px;
    font-size: 0.9em;
    text-align: left;
  }
  #help-checkbox-container input[type="checkbox"] {
    margin-right: 5px;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="loading">読み込み中…</div>
<div id="hypo-info"></div>
<div id="max-intensity">
  <div class="label">最大震度</div>
  <div class="scale">--</div>
</div>
<div id="minimap" style="width:150px;height:200px;position:absolute;bottom:20px;right:20px;z-index:99999;border:3px solid black;background:white;display:none;"></div>

<!-- ヘルプボタン -->
<div id="help-button">？</div>

<!-- ポップアップ -->
<div id="help-popup">
  <div class="popup-content">
    <span id="popup-close">&times;</span>
<div id="help-checkbox-container">
  <label>
    <input type="checkbox" id="show-minimap-checkbox">
    表示範囲を示す<br>
  </label>
  <label>幅(px): <input type="number" id="minimap-width" value="150"></label><br>
  <label>高さ(px): <input type="number" id="minimap-height" value="200"></label><br>
  <button id="update-minimap-size">更新</button>
</div>
<p><b>地震マップ</b><br>
各地の震度アイコンを押すと、<br>観測点名のポップアップを表示します。<br>
P2P地震情報APIの更新状況により、<br>タイムラグが生じる場合があります。<br>
情報を更新するにはリロードしてください。<br>
バグや意見があれば報告お願いします<br>
＝　＝　＝<br>
【情報源】<br><a href="https://www.p2pquake.net/develop/json_api_v2/" target="_brank">P2P地震情報API</a><br>
座標データは<a href="https://gist.github.com/iku55/79005d1896631ad6117bbe327b8162c1" target="_blank">iku55</a>様のjsonを使用<br>
【地図】<br>(c)<a href="https://carto.com/" target="_blank">CARTO</a><br>
【制作】<br>NAFY/なふぃー　ChatGPT<br>
Google Apps Script
</p>


<style>
  /* ヘルプボタン */
  #help-button {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    background: #0078ff;
    color: white;
    font-weight: bold;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 66px;
    cursor: pointer;
    z-index: 100000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: "Hiragino Maru Gothic ProN", "Rounded Mplus 1c", "Yu Gothic", "Meiryo", sans-serif;
  }

  /* ポップアップ本体 */
  #help-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 100001;
    justify-content: center;
    align-items: center;
  }

  .popup-content {
    background: #fff;
    padding: 20px 30px;
    border-radius: 8px;
    position: relative;
    max-width: 400px;
    width: 80%;
    max-height: 70vh;       /* 高さ制限（画面の70%まで） */
    overflow-y: auto;       /* 縦スクロール有効 */
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-family: "Yu Gothic","メイリオ",sans-serif;
  }

  /* 閉じるボタン */
  #popup-close {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 22px;
    font-weight: bold;
    color: #666;
    cursor: pointer;
  }
</style>

<script>
  // 開く・閉じる動作
  const helpButton = document.getElementById('help-button');
  const helpPopup = document.getElementById('help-popup');
  const popupClose = document.getElementById('popup-close');

  helpButton.addEventListener('click', () => {
    helpPopup.style.display = 'flex';
  });

  popupClose.addEventListener('click', () => {
    helpPopup.style.display = 'none';
  });

  helpPopup.addEventListener('click', e => {
    if (e.target === helpPopup) helpPopup.style.display = 'none';
  });
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ==================== 地震マップβ版 最終完全版 ====================

// メイン地図の初期化
const map = L.map('map').setView([37.5, 138], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; CARTO',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

map.createPane('hypocenterPane');
map.getPane('hypocenterPane').style.zIndex = 10000;

// 震度ごとの色設定（そのまま）
const colors = {"1":"#dcdcdc","2":"#00aaff","3":"#0041ff","4":"#fae696",
                "5-":"#ffe600","5+":"#ffc800","6-":"#ff2800","6+":"#a50021","7":"#b40068"};
const textColors = {"1":"#000","2":"#fff","3":"#fff","4":"#000",
                    "5-":"#000","5+":"#fff","6-":"#fff","6+":"#fff","7":"#fff"};
const intensityOrder = {"1":1,"2":2,"3":3,"4":4,"5-":5,"5+":6,"6-":7,"6+":8,"7":9};
const p2pToShindo = {10:"1",20:"2",30:"3",40:"4",45:"5-",50:"5+",55:"6-",60:"6+",70:"7"};

function getTextColor(rgb){
  const [r,g,b] = rgb.match(/\d+/g).map(Number);
  return (r*299 + g*587 + b*114)/1000 > 128 ? "black" : "white";
}

function addIntensityMarker(lat, lon, intensity, popupText){
  const color = colors[intensity] || "gray";
  const textColor = textColors[intensity] || getTextColor(color);
  const icon = L.divIcon({
    className: '',
    html: `<div class="intensity-marker" style="background:${color};color:${textColor}">${intensity}</div>`,
    iconSize: [96,96],
    iconAnchor: [48,48]
  });
  const marker = L.marker([lat,lon], {
    icon: icon,
    interactive: true,
    zIndexOffset: (intensityOrder[intensity]||0)*1000
  }).addTo(map);
  if(popupText) marker.bindPopup(popupText);
}

function updateMaxIntensityPosition(){
  const hypoInfoEl = document.getElementById('hypo-info');
  const maxIntensityEl = document.getElementById('max-intensity');
  const rect = hypoInfoEl.getBoundingClientRect();
  maxIntensityEl.style.top = (rect.bottom + 5) + 'px';
}

function buildTsunamiText(domestic, foreign){
  const d = domestic || "Unknown";
  const f = foreign || "";
  if(d==="Warning" || d==="Watch") return "津波情報を発表中";
  if(d==="NonEffective") return "若干の海面変動あり";
  if(d==="None"){
    if(f==="Warning" || f==="Watch" || f==="WarningNearby") return "国内では津波の心配なし";
    return "津波の心配なし";
  }
  if(d==="Checking") return "津波の有無を調査中";
  if(d==="Unknown") return "津波の有無は不明";
  return "津波の有無は不明";
}

async function loadCoordMap() {
  const res = await fetch('./coords.json');
  if (!res.ok) throw new Error('coords.json が読めません');
  const arr = await res.json();

  const map = {};
  arr.forEach(p => {
    map[p.name] = {
      lat: Number(p.lat),
      lon: Number(p.lon)
    };
  });

  return map;
}
  
// ==================== 地震情報取得（そのまま）===================
(async () => {
  try {
    const res = await fetch('https://api.p2pquake.net/v2/history?codes=551&limit=5');
    const data = await res.json();

    for(const eqData of data){
      const type = eqData.issue?.type;
      if(type !== "DetailScale" && type !== "Foreign") continue;

      const points = eqData.points;

      await new Promise(async (resolve, reject) => {
        try {
          // ★ 座標をローカルJSONから取得
          const coordMap = await loadCoordMap();
      
          let latlngs = [];
          points.forEach(p => {
            const latlon = coordMap[p.addr];
            const intensity = p2pToShindo[p.scale];
            if (latlon && intensity) {
              addIntensityMarker(latlon.lat, latlon.lon, intensity, p.addr);
              latlngs.push([latlon.lat, latlon.lon]);
            }
          });
      
          const eq = eqData.earthquake;
          const hypo = eq.hypocenter;
      
          if (hypo?.latitude != null && hypo?.longitude != null &&
              hypo.latitude !== -200 && hypo.longitude !== -200) {
            latlngs.push([hypo.latitude, hypo.longitude]);
          }
      
          if (latlngs.length > 0) {
            map.fitBounds(L.latLngBounds(latlngs), {
              padding:[150,150],
              maxZoom:8
            });
          }
      
          document.getElementById('loading').style.display='none';
          const hypoInfoEl = document.getElementById('hypo-info');
      
          // ===== 震源マーカー =====
          if (hypo?.latitude != null && hypo?.longitude != null &&
              hypo.latitude !== -200 && hypo.longitude !== -200) {
              
        const size = 90;      // 3倍後サイズ
        const stroke = 15;   // 線の太さ
        const lat = hypo.latitude;
        const lon = hypo.longitude;
        
        const crossIcon = L.divIcon({
          className: '',
          html: `
            <svg width="${size}" height="${size}"
                 viewBox="0 0 100 100"
                 style="display:block;">
              <line x1="50" y1="0" x2="50" y2="100"
                    stroke="red" stroke-width="${stroke}"/>
              <line x1="0" y1="50" x2="100" y2="50"
                    stroke="red" stroke-width="${stroke}"/>
            </svg>
          `,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2],
          pane: 'hypocenterPane'
        });
        
            const crossMarker = L.marker([lat,lon], {
              icon:crossIcon,
              interactive:false,
              zIndexOffset:10000
            }).addTo(map);
      
            function blink(){
              const el = crossMarker.getElement();
              if(!el) return;
              el.style.display='block';
              setTimeout(()=>el.style.display='none',2500);
            }
            setInterval(blink, 3000);
            blink();
          }
      
          // ===== 情報表示 =====
          let nameText = (hypo?.name && hypo.name.trim() !== '') ? hypo.name : '震源地不明';
          let depthText = (hypo?.depth != null)
            ? (hypo.depth === -1 ? '不明' : (hypo.depth === 0 ? 'ごく浅い' : hypo.depth+'km'))
            : '不明';
          let magnitudeText = (hypo?.magnitude != null)
            ? (hypo.magnitude === -1 ? '不明' : hypo.magnitude.toFixed(1))
            : '不明';
      
          let timeText = '不明';
          if(eq.time){
            const date = new Date(eq.time);
            if(!isNaN(date)){
              const yyyy = date.getFullYear();
              const MM = String(date.getMonth()+1).padStart(2,'0');
              const dd = String(date.getDate()).padStart(2,'0');
              const HH = String(date.getHours()).padStart(2,'0');
              const mm = String(date.getMinutes()).padStart(2,'0');
              timeText = `${yyyy}/${MM}/${dd} ${HH}:${mm}頃`;
            }
          }
      
          const tsunami = buildTsunamiText(eq.domesticTsunami, eq.foreignTsunami);
      
          hypoInfoEl.innerHTML = `▼EARTH地震情報▼<br>
${timeText}<br>
震源: ${nameText}<br>
M${magnitudeText}　深さ 約${depthText}<br>
${tsunami}<br>
      <span style="font-size:0.8em;font-weight:normal;">EARTH地震マップv1.10.7</span>
      `;
      
          // ===== 最大震度 =====
          const maxIntensityEl = document.getElementById('max-intensity');
          const scaleEl = maxIntensityEl.querySelector('.scale');
          const labelEl = maxIntensityEl.querySelector('.label');
      
          const maxScaleMap = {10:"1",20:"2",30:"3",40:"4",45:"5-",50:"5+",55:"6-",60:"6+",70:"7"};
          const maxScale = eq.maxScale;
          const intensity = maxScaleMap[maxScale] || "--";
      
          scaleEl.textContent = intensity;
      
          if (intensity === "--") {
            maxIntensityEl.style.background = "#ffffff";
            labelEl.style.color = "#000000";
            scaleEl.style.color = "#000000";
          } else {
            const bgColor = colors[intensity];
            const txtColor = textColors[intensity] || getTextColor(bgColor);
            maxIntensityEl.style.background = bgColor;
            labelEl.style.color = txtColor;
            scaleEl.style.color = txtColor;
          }
      
          updateMaxIntensityPosition();
          window.addEventListener('resize', updateMaxIntensityPosition);
      
          resolve();
        } catch(e) {
          reject(e);
        }
      });

      break; // 最新の1件だけ表示
    }

  } catch(error){
    const loadingEl = document.getElementById('loading');
    loadingEl.innerHTML = `<b>エラー</b><br>
エラーが発生しました。<br>
ページを更新して実行しなおしてください。<br>
繰り返し発生する場合は報告をお願いします。<br>
=ErrorCode=<br>
(${error.message})`;
    console.error(error);
  }
})();

// ==================== ミニマップ（完璧版）===================
function initMiniMap() {
  if (map._miniMap) return;

  // 入力値取得（デフォルトは200x100）
  const w = parseInt(document.getElementById('minimap-width')?.value) || 200;
  const h = parseInt(document.getElementById('minimap-height')?.value) || 100;

  const miniMapEl = document.getElementById('minimap');
  miniMapEl.style.width = w + 'px';
  miniMapEl.style.height = h + 'px';

  const miniMap = L.map(miniMapEl, {
    attributionControl: false,
    zoomControl: false,
    dragging: true,
    scrollWheelZoom: true,
    doubleClickZoom: true,
    boxZoom: false,
    keyboard: false,
    touchZoom: true,
    tap: true
  }).setView([37.5, 138], 5);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(miniMap);

  const rect = L.rectangle(map.getBounds(), {
    color: "#ff0000",
    weight: 3,
    fillOpacity: 0,
    interactive: false
  }).addTo(miniMap);

  map.on('moveend', () => rect.setBounds(map.getBounds()));
  rect.setBounds(map.getBounds());
  miniMapEl.style.display = 'block';

  map._miniMap = miniMap;
  map._miniMapRect = rect;
}

// 入力値を反映するボタン
document.getElementById('update-minimap-size').addEventListener('click', () => {
  if(map._miniMap) {
    map._miniMap.remove(); // 古いミニマップ削除
    map._miniMap = null;
    map._miniMapRect = null;
  }
  initMiniMap(); // 再生成
});

// ==================== チェックボックス＋ヘルプボタン（これで絶対動く）===================
document.addEventListener('DOMContentLoaded', () => {
  // ミニマップチェックボックス
  const checkbox = document.getElementById('show-minimap-checkbox');
  if (checkbox) {
    checkbox.addEventListener('change', e => {
      if (e.target.checked) {
        initMiniMap();
      } else {
        document.getElementById('minimap').style.display = 'none';
        if (map._miniMap) {
          map._miniMap.remove();
          map._miniMap = null;
          map._miniMapRect = null;
        }
      }
    });
  }

  // ヘルプボタン＆ポップアップ
  const helpButton = document.getElementById('help-button');
  const helpPopup = document.getElementById('help-popup');
  const popupClose = document.getElementById('popup-close');

  if (helpButton && helpPopup) {
    helpButton.addEventListener('click', () => helpPopup.style.display = 'flex');
    popupClose.addEventListener('click', () => helpPopup.style.display = 'none');
    helpPopup.addEventListener('click', e => {
      if (e.target === helpPopup) helpPopup.style.display = 'none';
    });
  }
});
</script>
</body>
</html>
